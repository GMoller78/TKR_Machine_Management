{# tkr_system/app/templates/pm_job_card_detail.html #}
{% extends "pm_base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .detail-card { margin-top: 1.5rem; }
    .detail-card .card-header { font-weight: 600; }
    .list-group-item span.label {
        font-weight: 500;
        min-width: 150px; /* Adjust as needed */
        display: inline-block;
        color: #555;
    }
    .list-group-item span.value {
        color: #333;
    }
    .parts-list th { font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {# -- Row for Title and Actions -- #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">{{ title }}</h1>
        <div>
            {# -- NEW Print Button -- #}
            <button class="btn btn-secondary me-2 d-print-none" onclick="window.print();">
                <i class="bi bi-printer me-1"></i> Print Job Card
            </button>
             {# -- Link back to dashboard or relevant list -- #}
            <a href="{{ url_for('planned_maintenance.dashboard') }}" class="btn btn-outline-secondary d-print-none">
                <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
            </a>
            {# Optional: Re-add WhatsApp share button here if needed, potentially using session flash #}
        </div>
    </div>
    {# -- END Row for Title and Actions -- #}

    <div class="row">
        {# Job Card Info Column #}
        <div class="col-md-6 mb-4">
            <div class="card h-100"> {# Use h-100 for equal height if needed #}
                <div class="card-header">
                    Job Details
                </div>
                <div class="card-body">
                     <dl class="row mb-0">
                        <dt class="col-sm-4">Job Number:</dt>
                        <dd class="col-sm-8">{{ job_card.job_number }}</dd>

                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            <span class="badge {% if job_card.status == 'Done' %}bg-success{% elif job_card.status == 'To Do' %}bg-warning text-dark{% elif job_card.status == 'In Progress' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
                                {{ job_card.status }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">Description:</dt>
                        <dd class="col-sm-8">{{ job_card.description }}</dd>

                        <dt class="col-sm-4">Technician:</dt>
                        <dd class="col-sm-8">{{ job_card.technician or 'N/A' }}</dd>

                        <dt class="col-sm-4">Due Date:</dt>
                        <dd class="col-sm-8">{{ job_card.due_date.strftime('%Y-%m-%d') if job_card.due_date else 'Not Set' }}</dd>

                        {# Display completion details only if 'Done' #}
                        {% if job_card.status == 'Done' %}
                            <dt class="col-sm-4">Checked Out:</dt>
                            <dd class="col-sm-8">{{ job_card.start_datetime.strftime('%Y-%m-%d %H:%M') if job_card.start_datetime else 'N/A' }}</dd>

                            <dt class="col-sm-4">Checked In:</dt>
                            <dd class="col-sm-8">{{ job_card.end_datetime.strftime('%Y-%m-%d %H:%M') if job_card.end_datetime else 'N/A' }}</dd>

                            <dt class="col-sm-4">Comments:</dt>
                            <dd class="col-sm-8"><pre class="mb-0" style="white-space: pre-wrap;">{{ job_card.comments or 'None' }}</pre></dd> {# Use <pre> for comments #}
                         {% endif %}

                        <dt class="col-sm-4">OEM Required:</dt>
                        <dd class="col-sm-8">{{ 'Yes' if job_card.oem_required else 'No' }}</dd>

                        <dt class="col-sm-4">Kit Required:</dt>
                        <dd class="col-sm-8">{{ 'Yes' if job_card.kit_required else 'No' }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        {# Equipment & Parts Column #}
        <div class="col-md-6 mb-4">
             {# Equipment Details Card #}
             <div class="card mb-4">
                 <div class="card-header">Equipment Details</div>
                 <div class="card-body">
                      <dl class="row mb-0">
                         <dt class="col-sm-4">Code:</dt>
                         <dd class="col-sm-8">{{ job_card.equipment_ref.code }}</dd>

                         <dt class="col-sm-4">Name:</dt>
                         <dd class="col-sm-8">{{ job_card.equipment_ref.name }}</dd>

                         <dt class="col-sm-4">Type:</dt>
                         <dd class="col-sm-8">{{ job_card.equipment_ref.type }}</dd>

                         <dt class="col-sm-4">Status:</dt>
                         <dd class="col-sm-8">{{ job_card.equipment_ref.status }}</dd>
                     </dl>
                 </div>
             </div>

             {# Parts Used Card (only show if parts exist or JC is done) #}
             {% if job_card.parts_used or job_card.status == 'Done' %}
                <div class="card">
                    <div class="card-header">Parts Used</div>
                    <div class="card-body p-0"> {# Remove padding for table #}
                        {% if job_card.parts_used %}
                            <div class="table-responsive">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>Part Name</th>
                                            <th>Store</th>
                                            <th>Supplier</th>
                                            <th>Quantity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for jc_part in job_card.parts_used %}
                                            <tr>
                                                <td>{{ jc_part.part.name }}</td>
                                                <td>{{ jc_part.part.store }}</td>
                                                <td>{{ jc_part.part.supplier_ref.name if jc_part.part.supplier_ref else 'N/A' }}</td>
                                                <td>{{ jc_part.quantity }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                             <div class="card-body"> {# Add padding back if no parts #}
                                <p class="text-muted mb-0">No parts were recorded for this job card.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
             {% endif %}
        </div>
    </div> {# End row #}

</div> {# End Container-fluid #}
{% endblock %}