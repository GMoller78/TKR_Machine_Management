{# tkr_system/app/templates/maintenance_plan_detail.html #}
{% extends "pm_base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .detail-header {
        background-color: #e9ecef;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
        border-radius: 0.3rem 0.3rem 0 0;
    }
    .detail-header h2 {
        margin-bottom: 0.25rem;
    }
    .filter-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.3rem;
    }
    .day-section {
        margin-bottom: 2rem; /* Increased space between days */
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }
     .day-section:first-of-type {
        border-top: none; /* No top border for the first day */
         padding-top: 0;
    }
    .day-header {
        font-size: 1.4rem; /* Slightly larger day header */
        font-weight: 500;
        margin-bottom: 1.5rem;
        color: #0056b3; /* Darker blue */
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }

    /* Card Styling */
    .plan-card {
        /* Add h-100 if you want cards in the same row to have equal height */
         height: 100%;
         box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
         transition: box-shadow 0.2s ease-in-out;
    }
     .plan-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    .card-header {
        font-weight: 500;
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa; /* Light grey header */
    }
     .card-header .equipment-code {
        color: #343a40;
    }
     .card-body {
        padding: 0.75rem;
        font-size: 0.9rem;
    }
    .card-subtitle {
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .card-text small {
        display: block;
        margin-top: 0.3rem;
        color: #6c757d;
    }
    .card-badges {
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
    }
    .card-link-section {
        margin-top: 0.75rem;
        text-align: right;
    }

    /* Status Specific Card Borders/Backgrounds (Subtle) */
    .card-planned { border-left: 4px solid #0d6efd; /* Blue border */ }
    .card-planned.card-estimated {
        border-left-color: #ffc107; /* Yellow border for estimates */
        background-color: #fffcf1; /* Very light yellow bg */
    }
    .card-completed { border-left: 4px solid #198754; /* Green border */ }

    /* Badge Styling */
    .badge.bg-status-planned { background-color: #0d6efd !important; }
    .badge.bg-status-completed { background-color: #198754 !important; }
    .badge.bg-legal { background-color: #dc3545 !important; }
    .badge.bg-maintenance { background-color: #6c757d !important; }
    .badge.bg-estimate { background-color: #ffc107 !important; color: #343a40 !important; }
    .badge.bg-interval { background-color: #adb5bd !important; }


    .no-items-alert { font-style: italic; color: #6c757d; margin-top: 0.5rem; }
    .back-button { margin-bottom: 1rem; }
    .action-buttons { gap: 0.5rem; }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    {# --- Back Button, Header, Print/PDF Buttons (Keep As Is) --- #}
    <a href="{{ url_for('planned_maintenance.maintenance_plan_list_view') }}" class="btn btn-sm btn-outline-secondary back-button">
        <i class="bi bi-arrow-left"></i> Back to Plan List
    </a>

    <div class="detail-header d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2>{{ month_name }} - Plan Details</h2>
            <small class="text-muted">{{ generation_info }}</small>
        </div>
        <div class="d-flex action-buttons mt-2 mt-md-0">
            <a href="{{ url_for('planned_maintenance.print_maintenance_plan_detail', year=current_year, month=current_month, equipment_type=current_equipment_type_filter or '') }}" class="btn btn-sm btn-info" target="_blank" title="Open Printable View">
                <i class="bi bi-printer-fill"></i> Print Plan
            </a>
            {% if WEASYPRINT_AVAILABLE %}
            <a href="{{ url_for('planned_maintenance.maintenance_plan_pdf', year=current_year, month=current_month) }}" class="btn btn-sm btn-danger" target="_blank" title="Download PDF (Original Calendar Layout)">
                <i class="bi bi-file-earmark-pdf-fill"></i> PDF (Calendar)
            </a>
            {% else %}
            <button class="btn btn-sm btn-secondary" disabled title="PDF Library (WeasyPrint) not installed">
                <i class="bi bi-file-earmark-pdf-fill"></i> PDF Disabled
            </button>
            {% endif %}
        </div>
    </div>

    {# --- Filter Section (Keep As Is) --- #}
    <div class="filter-section">
        <form method="GET" action="{{ url_for('planned_maintenance.maintenance_plan_detail_view') }}" class="row g-3 align-items-end">
             <input type="hidden" name="year" value="{{ current_year }}">
             <input type="hidden" name="month" value="{{ current_month }}">
             <div class="col-md-4">
                 <label for="equipment_type" class="form-label">Filter by Equipment Type:</label>
                 <select name="equipment_type" id="equipment_type" class="form-select form-select-sm">
                     <option value="All" {% if not current_equipment_type_filter or current_equipment_type_filter == 'All' %}selected{% endif %}>-- All Types --</option>
                     {% for type_name in equipment_types | sort %}
                         <option value="{{ type_name }}" {% if current_equipment_type_filter == type_name %}selected{% endif %}>{{ type_name }}</option>
                     {% endfor %}
                 </select>
             </div>
             <div class="col-md-2">
                 <button type="submit" class="btn btn-primary btn-sm w-100">
                     <i class="bi bi-filter"></i> Filter
                 </button>
             </div>
             {% if current_equipment_type_filter and current_equipment_type_filter != 'All' %}
             <div class="col-md-2">
                 <a href="{{ url_for('planned_maintenance.maintenance_plan_detail_view', year=current_year, month=current_month) }}" class="btn btn-outline-secondary btn-sm w-100">
                     Clear Filter
                 </a>
             </div>
             {% endif %}
         </form>
    </div>


    {# --- Daily Plan Data --- #}
    {% if daily_plan_data %}
        {% for day_date, data in daily_plan_data.items() %}
        <div class="day-section">
            <h3 class="day-header"><i class="bi bi-calendar-date me-2"></i>{{ day_date.strftime('%A, %d %B %Y') }}</h3>

            {# --- Card Grid Row --- #}
            <div class="row g-3"> {# g-3 adds gutters between columns #}

                {# Planned Task Cards #}
                {% if data.planned %}
                    {% for item in data.planned | sort(attribute='equipment.code') %}
                    <div class="col-md-6 col-lg-4"> {# Adjust columns: 2 on med, 3 on lg screens #}
                        <div class="card plan-card card-planned {% if item.is_estimate %}card-estimated{% endif %}">
                            <div class="card-header">
                                <span class="equipment-code">
                                    <i class="bi bi-tools text-secondary me-1"></i>
                                    {{ item.equipment.code if item.equipment else 'N/A' }}
                                </span>
                                <span class="badge bg-status-planned rounded-pill">Planned</span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">{{ item.equipment.name if item.equipment else 'N/A' }}</h6>
                                <p class="card-text">{{ item.description }}</p>
                                <div class="card-badges">
                                    {% if item.is_legal %}
                                        <span class="badge bg-legal"><i class="bi bi-shield-fill-exclamation me-1"></i>Legal</span>
                                    {% else %}
                                        <span class="badge bg-maintenance">Maintenance</span>
                                    {% endif %}
                                    {% if item.is_estimate %}
                                        <span class="badge bg-estimate"><i class="bi bi-clock-history me-1"></i>Est.</span>
                                    {% endif %}
                                     <span class="badge bg-interval">{{ item.entry.interval_type }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                {# Completed Job Cards #}
                {% if data.completed %}
                    {% for item in data.completed | sort(attribute='equipment.code') %}
                     <div class="col-md-6 col-lg-4">
                        <div class="card plan-card card-completed">
                             <div class="card-header">
                                 <span class="equipment-code">
                                     <i class="bi bi-truck text-success me-1"></i>
                                     {{ item.equipment.code if item.equipment else 'N/A' }}
                                 </span>
                                 <span class="badge bg-status-completed rounded-pill">Completed</span>
                             </div>
                             <div class="card-body">
                                 <h6 class="card-subtitle mb-2 text-muted">{{ item.equipment.name if item.equipment else 'N/A' }}</h6>
                                 <p class="card-text">{{ item.description }}</p>
                                 <div class="card-badges">
                                     {% if item.is_legal %}
                                         <span class="badge bg-legal"><i class="bi bi-shield-fill-exclamation me-1"></i>Legal</span>
                                     {% else %}
                                        <span class="badge bg-maintenance">Maintenance</span>
                                     {% endif %}
                                 </div>
                                 <p class="card-text">
                                     <small>
                                         Completed: {{ item.job_card.end_datetime.strftime('%H:%M') if item.job_card.end_datetime }}<br>
                                         Technician: {{ item.job_card.technician or 'N/A' }}
                                    </small>
                                 </p>
                                 <div class="card-link-section">
                                     <a href="{{ url_for('planned_maintenance.job_card_detail', id=item.job_card.id) }}" class="btn btn-outline-success btn-sm" title="View Job Card {{ item.job_card.job_number }}">
                                         <i class="bi bi-clipboard-check"></i> {{ item.job_card.job_number }}
                                     </a>
                                 </div>
                             </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                 {% if not data.planned and not data.completed %}
                    <div class="col-12">
                        <p class="no-items-alert text-center">No items scheduled or completed for this day.</p>
                    </div>
                 {% endif %}

            </div> {# End row g-3 #}
        </div> {# End day-section #}
        {% endfor %} {# End daily_plan_data loop #}

    {% elif error %}
         {# --- Error Message (Keep As Is) --- #}
         <div class="alert alert-danger">
            <strong>Error:</strong> {{ error }}
        </div>
    {% else %}
         {# --- No Data Message (Keep As Is) --- #}
         <div class="alert alert-info mt-3">
             {% if current_equipment_type_filter and current_equipment_type_filter != 'All' %}
                 No planned tasks or completed job cards found for {{ month_name }} matching the filter: <strong>{{ current_equipment_type_filter }}</strong>.
                 <a href="{{ url_for('planned_maintenance.maintenance_plan_detail_view', year=current_year, month=current_month) }}" class="alert-link">Clear filter</a>?
             {% else %}
                 No planned tasks or completed job cards found for {{ month_name }}. Check if the plan was generated or if jobs were completed in this period.
             {% endif %}
        </div>
    {% endif %} {# End if daily_plan_data #}

</div> {# End container #}
{% endblock %}