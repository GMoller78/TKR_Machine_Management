{# tkr_system/app/templates/pm_tasks.html #}
{% extends "pm_base.html" %}

{% block title %}Maintenance Tasks - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Maintenance Task Schedule</h1>
        <a href="{{ url_for('planned_maintenance.add_task') }}" class="btn btn-success">Add New Task</a>
    </div>

    <!-- Type Filter -->
    <div class="mb-4">
        <form method="GET" action="{{ url_for('planned_maintenance.tasks_list') }}">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label for="typeFilter" class="form-label">Filter by Equipment Type:</label>
                </div>
                <div class="col-auto">
                    <select name="type" id="typeFilter" class="form-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        {% for type in equipment_types %}
                            <option value="{{ type }}" {% if type == type_filter %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    {% if tasks_by_equipment %}
        <div class="accordion" id="tasksAccordion">
            {% for (code, name, eq_type), tasks in tasks_by_equipment.items()|sort %} {# Sort equipment for consistency #}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" {# Start collapsed #}
                                data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}"
                                aria-expanded="false"
                                aria-controls="collapse-{{ loop.index }}">
                            {{ code }} - {{ name }} ({{ eq_type }}) <span class="ms-2 badge bg-info">{{ tasks|length }} Tasks</span>
                        </button>
                    </h2>
                    <div id="collapse-{{ loop.index }}"
                         class="accordion-collapse collapse" {# Start collapsed #}
                         aria-labelledby="heading-{{ loop.index }}"
                         data-bs-parent="#tasksAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm"> {# table-sm for denser layout #}
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Interval</th>
                                            {# <th>Type</th> #} {# Interval contains type now #}
                                            {# <th>OEM Req.</th> #} {# Less critical for overview? #}
                                            {# <th>Kit Req.</th> #}
                                            <th>Last Performed</th> <!-- NEW/MODIFIED -->
                                            <th>Next Due</th> <!-- NEW/MODIFIED -->
                                            <th>Remaining</th> <!-- NEW -->
                                            <th>Est. Time</th> <!-- NEW -->
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {# Remove the sort filter here - tasks list is now pre-sorted #}
                                        {% for task in tasks %}
                                        <tr class="
                                            {% if 'Overdue' in task.due_status %}table-danger
                                            {% elif 'Due Soon' in task.due_status %}table-warning
                                            {% elif 'Warning' in task.due_status %}table-info
                                            {% elif 'Error' in task.due_status %}table-secondary
                                            {% endif %}
                                        ">
                                            <td>{{ task.description }}</td>
                                            <td>{{ task.interval_value }} {{ task.interval_type }}</td>
                                            <td><small>{{ task.last_performed_info | replace('hours', 'hrs') | replace('kilometers', 'km') or 'N/A' }}</small></td>
                                            <td><small>{{ task.next_due_info | replace('hours', 'hrs') | replace('kilometers', 'km') or 'N/A' }}</small></td>
                                            <td><small>{{ task.due_info | replace('hours', 'hrs') | replace('kilometers', 'km') or 'N/A' }}</small></td>
                                            <td><small>{{ task.estimated_days_info or 'N/A' }}</small></td>
                                            <td>
                                                <span class="badge
                                                    {% if 'Overdue' in task.due_status %}bg-danger
                                                    {% elif 'Due Soon' in task.due_status %}bg-warning text-dark
                                                    {% elif 'OK' in task.due_status %}bg-success
                                                    {% elif 'Warning' in task.due_status %}bg-info text-dark
                                                    {% else %}bg-secondary
                                                    {% endif %}">
                                                    {{ task.due_status }}
                                                </span>
                                            </td>
                                            <td>
                                                 <form action="{{ url_for('planned_maintenance.new_job_card_from_task', task_id=task.id) }}" method="POST" class="d-inline">
                                                    <input type="text" name="technician" placeholder="Tech" class="form-control form-control-sm d-inline-block" style="width: 80px;" title="Assign Technician & Create Job Card">
                                                    <button type="submit" class="btn btn-sm btn-primary" title="Create Job Card"><i class="bi bi-journal-plus"></i></button> {# Icon example #}
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <p class="mt-3"><small>Note: Task status and estimates depend on regular usage logging. Status colours: Red (Overdue), Yellow (Due Soon), Green (OK), Blue (Warning/Data Issue), Grey (Other/Error).</small></p>
    {% else %}
        <p class="text-muted">No maintenance tasks have been defined yet{% if type_filter %} for type "{{ type_filter }}"{% endif %}.</p>
    {% endif %}
</div>
{% endblock %}