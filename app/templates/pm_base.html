
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}TKR Planned Maintenance{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    {# Optional: Font Awesome for pencil icon in modals #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Optional: Add custom CSS link here -->
    {% block styles %}

    {% endblock styles %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('planned_maintenance.dashboard') }}">TKR PM</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#pmNavbar" aria-controls="pmNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="pmNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'planned_maintenance.dashboard' %}active{% endif %}" aria-current="page" href="{{ url_for('planned_maintenance.dashboard') }}">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'planned_maintenance.equipment_list' %}active{% endif %}" href="{{ url_for('planned_maintenance.equipment_list') }}">Equipment</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'planned_maintenance.tasks_list' %}active{% endif %}" href="{{ url_for('planned_maintenance.tasks_list') }}">Maintenance Tasks</a>
            </li>
             <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'planned_maintenance.legal_tasks_list' %}active{% endif %}" href="{{ url_for('planned_maintenance.legal_tasks_list') }}">Legal Compliance</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle 
                 {% if request.endpoint == 'planned_maintenance.job_card_list' or 
                      request.endpoint == 'planned_maintenance.job_card_reports_dashboard' or
                      request.endpoint == 'planned_maintenance.report_jobs_by_technician' %}active{% endif %}" 
                 href="#" id="navbarDropdownJobCards" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Job Cards
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDropdownJobCards">
                <li>
                  <a class="dropdown-item {% if request.endpoint == 'planned_maintenance.job_card_list' %}active{% endif %}" 
                     href="{{ url_for('planned_maintenance.job_card_list') }}">Job Card List</a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.endpoint == 'planned_maintenance.job_card_reports_dashboard' %}active{% endif %}" 
                     href="{{ url_for('planned_maintenance.job_card_reports_dashboard') }}">Reports & Metrics</a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'planned_maintenance.maintenance_plan_list_view' %}active{% endif %}" href="{{ url_for('planned_maintenance.maintenance_plan_list_view') }}">Planning</a>
            </li>
            <!-- Add other PM links as needed -->
             <li class="nav-item dropdown"> {# Added dropdown for Logs #}
                <a class="nav-link dropdown-toggle {% if request.endpoint.endswith('_logs') %}active{% endif %}" href="#" id="navbarDropdownLogs" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Logs
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDropdownLogs">
                    <li><a class="dropdown-item {% if request.endpoint == 'planned_maintenance.checklist_logs' %}active{% endif %}" href="{{ url_for('planned_maintenance.checklist_logs') }}">Checklist Logs</a></li>
                    <li><a class="dropdown-item {% if request.endpoint == 'planned_maintenance.usage_logs' %}active{% endif %}" href="{{ url_for('planned_maintenance.usage_logs') }}">Usage Logs</a></li>
                    {# Add other log links here if needed #}
                </ul>
            </li>
          </ul>
           <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
             <li class="nav-item">
               <a class="nav-link" href="{{ url_for('inventory.dashboard') }}">Switch to Inventory</a>
             </li>
           </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4"> {# Changed container to container-fluid for wider layout #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {# Use safe filter for messages potentially containing HTML #}
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}
      {% endblock %}
    </div> {# End container-fluid #}

    {# -------- Generic Log Edit Modal -------- #}
    <div class="modal fade" id="editLogModal" tabindex="-1" aria-labelledby="editLogModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="editLogModalLabel">Log Details</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="editLogModalBody">
                  <!-- Dynamic content loaded here -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
    {# -------- End Generic Log Edit Modal -------- #}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    {# Include jQuery if needed by other scripts, Bootstrap 5 doesn't require it #}
    {# <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> #}

    {# -------- Scripts Block -------- #}
    {% block scripts %}
        {# Page-specific scripts will be inserted here by child templates using super() #}

        {# Script for Tooltips and Edit Modal #}
        <script>
          // Pass the base URL from Flask to JavaScript
          const BASE_URL = "{{ base_url|default('', true) }}"; // Fallback to empty string if not provided
  
          const editLogModal = document.getElementById('editLogModal');
          const modalTitle = editLogModal.querySelector('.modal-title');
          const modalBody = editLogModal.querySelector('.modal-body');
          const modalInstance = new bootstrap.Modal(editLogModal);
  
          // Escape HTML to prevent XSS
          function escapeHtml(unsafe) {
              return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
          }
  
          // Handle click on edit log trigger
          document.body.addEventListener('click', function(event) {
              const trigger = event.target.closest('.edit-log-trigger');
              if (!trigger) return;
              event.preventDefault();
  
              const logType = trigger.dataset.logType;
              const equipmentId = trigger.dataset.equipmentId;
              const equipmentCode = trigger.dataset.equipmentCode;
              const logDate = trigger.dataset.logDate;
  
              modalTitle.textContent = `Logs for ${equipmentCode} on ${logDate}`;
              modalBody.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Fetching logs...</div>';
              modalInstance.show();
  
              // Construct the URL using BASE_URL
              const fetchUrl = `${BASE_URL}/logs/get_for_cell?log_type=${logType}&equipment_id=${equipmentId}&log_date=${logDate}`;
              fetch(fetchUrl)
                  .then(response => {
                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`);
                      }
                      return response.json();
                  })
                  .then(data => {
                      if (data.logs.length === 0) {
                          modalBody.innerHTML = '<div class="alert alert-info m-3">No logs found for this date.</div>';
                          return;
                      }
                      let html = '<div class="list-group">';
                      for (const log of data.logs) {
                          const timestamp = escapeHtml(log.timestamp);
                          html += `
                              <div class="list-group-item">
                                  <div class="d-flex w-100 justify-content-between">
                                      <h6 class="mb-1">Log at ${timestamp}</h6>
                                      <button class="btn btn-sm btn-outline-primary edit-log-item-btn"
                                              data-form-url="${log.edit_url}" 
                                              data-log-id="${log.id}">
                                          <i class="fas fa-edit"></i> Edit
                                      </button>
                                  </div>`;
                          if (logType === 'checklist') {
                              html += `
                                  <p class="mb-1"><strong>Status:</strong> ${escapeHtml(log.status)}</p>
                                  <p class="mb-1"><strong>Issues:</strong> ${escapeHtml(log.issues)}</p>
                                  <p class="mb-0"><strong>Operator:</strong> ${escapeHtml(log.operator)}</p>
                              `;
                            } else if (logType === 'usage') {
                              // --- Execute JavaScript logic FIRST ---
                              const usageValue = log.value;
                              const usageValueDisplay = (usageValue != null)
                                  ? escapeHtml(usageValue.toString()) + ' Hours/KM'
                                  : '<span class="text-muted">N/A</span>'; // Calculate the display string

                              // --- THEN add the resulting HTML paragraph to the 'html' variable ---
                              html += `
                                  <p class="mb-0"><strong>Usage Value:</strong> ${usageValueDisplay}</p>
                              `; // Embed the calculated display string
                            }
                          html += '</div>';
                      }
                      html += '</div>';
                      modalBody.innerHTML = html;
                  })
                  .catch(error => {
                      console.error('Error fetching logs:', error);
                      modalBody.innerHTML = `<div class="alert alert-danger m-3">Could not fetch log details. ${error.message}</div>`;
                  });
          });
  
          // Handle click on "Edit" button inside the modal to load the edit form
          editLogModal.addEventListener('click', function(event) {
              if (event.target.classList.contains('edit-log-item-btn')) {
                  event.preventDefault();
                  const formUrl = event.target.dataset.formUrl;
                  const logId = event.target.dataset.logId;
  
                  modalBody.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Loading edit form...</div>';
                  modalTitle.textContent = `Edit Log Entry (ID: ${logId})`;
  
                  fetch(formUrl)
                      .then(response => {
                          if (!response.ok) {
                              throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`);
                          }
                          return response.text();
                      })
                      .then(html => {
                          modalBody.innerHTML = html;
                          const firstInput = modalBody.querySelector('input, select, textarea');
                          if (firstInput) firstInput.focus();
                      })
                      .catch(error => {
                          console.error('Error loading edit form:', error);
                          modalBody.innerHTML = `<div class="alert alert-danger m-3">Could not load edit form. ${error.message}</div>`;
                      });
              }
          });
  
          // Handle form submission via AJAX
          editLogModal.addEventListener('submit', function(event) {
              const form = event.target.closest('#checklistEditForm, #usageLogEditForm');
              if (!form) return;
              event.preventDefault();
  
              const formData = new FormData(form);
              fetch(form.action, {
                  method: 'POST',
                  body: formData
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      modalBody.innerHTML = '<div class="alert alert-success m-3">Log updated successfully!</div>';
                      setTimeout(() => modalInstance.hide(), 1500);
                  } else {
                      modalBody.innerHTML = `<div class="alert alert-danger m-3">${data.error}</div>`;
                  }
              })
              .catch(error => {
                  modalBody.innerHTML = `<div class="alert alert-danger m-3">Error: ${error.message}</div>`;
              });
          });
      </script>
    {% endblock scripts %}
    {# --------------------------------- #}

  </body>
</html>